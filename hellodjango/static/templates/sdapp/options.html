{% extends 'base.html' %}

{% load humanize %}

{% block content %}
<script src="/../static/static/js/jquery.js"></script>
<script type="text/javascript"
  src="/../static/static/js/dygraph-combined-dev.js"></script>

    <style type="text/css">
    #div_g {
      position: absolute;
      left: 0px;
      right: 20px;
      top: 45px;
      bottom: 25px;
    }
    .many .dygraph-legend > span { display: none; }

    .many .dygraph-legend > span.highlight { display: inline; }
    </style>


<div class="col-md-9">
  <h1>{{ issuer_name }} ({{ ticker }})</h1>
</div>
<div class="col-md-3">
  <div class="spacer20"></div>
  <div class="pull-right">
  
  {% if watchedname.exists %}
  <a class="btn btn-default" href="watchtoggle" role="button">
    <span class="glyphicon glyphicon-star" aria-hidden="true"></span> Receiving Alerts</a>
  {% else %}
  <a class="btn btn-default" href="watchtoggle" role="button">
    <span class="glyphicon glyphicon-star-empty" aria-hidden="true"></span> Not Receiving Alerts</a>
  {% endif %}
  
  </div>
</div>
<!-- Note that the below </div> tag is unmatched and closes a row opened in base.html.  The row following it is closed in the base.html file-->
</div>
<div class="row">



<div class="col-md-6">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Sentiment</h3>
    </div>
    <div class="panel-body" style="height:200px; overflow-y: scroll;">
    {% if rec != None %}
      
      <!-- Colors based on confidence -->
      {% if rec.confidence = "Strong" %}
      <h1 class="text-info" align="center">{{rec.confidence}}</h1>
      {% elif rec.confidence = "Moderate" %}
      <h1 class="text-default" align="center">{{rec.confidence}}</h1>
      {% elif rec.confidence = "Weak" %}
      <h1 class="text-muted" align="center">{{rec.confidence}}</h1>
      {% else %}

      {% endif %}
      <h3 align="center">and</h3>
      
      <!-- Colors based on sentiment -->
      {% if rec.sentiment = "Bullish" %}
      <h1 class="text-success" align="center">{{rec.sentiment}}</h1>
      {% elif rec.sentiment = "Bearish" %}
      <h1 class="text-danger" align="center">{{rec.sentiment}}</h1>
      {% else %}
      <h1 class="text-info" align="center">{{rec.sentiment}}</h1>
      {% endif %}
    {% else %}

      No recommendation at this time.

    {% endif %}

    </div>
  </div>  
</div>



<div class="col-md-6">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Stock Price Chart</h3>
    </div>
    <div class="panel-body" style="height:200px; overflow-y: scroll;">
      
      {% if price_csv != "Date,Temperature\n" %}
      <div id="div_g" ></div>
        <script type="text/javascript">
          var titles = {{ titles_json|safe }};
          var div = document.getElementById("div_g")
          div.className = "many";
          div.style.display = 'inline-block';
          var prices = {{ prices_json|safe }};
          var ymax = {{ ymax|safe }};
          // console.log(prices);
          // document.write(prices);
          var signal_highlights = {{ signal_highlights|safe }};
          // document.write(signal_highlights);
          var signal_highlights_len = signal_highlights.length;
          
          $(document).ready(function () 
          {
            new Dygraph(div,
            prices,
            {
              labels: titles,
              connectSeparatedPoints: true,
              // drawPoints: true,
              animatedZooms: true,
              highlightSeriesOpts: {
                strokeWidth: 2,
                strokeBorderWidth: 1,
                highlightCircleSize: 2,
              },
              // axisLabelColor: "rgba(0,0,0, 0.2)",
              // axisLineColor: "rgba(0,0,0, 0.2)",
              // color: "rgba(0,0,0, 0.2)",
              // errorBars: true,
              // sigma: 1.0,
              series: {
                'Close Price': {
                  axis: 'y2'
                },
              },

              axes: 
                {
                  x:
                  {
                    valueFormatter: Dygraph.dateString_,
                    axisLabelFormatter: Dygraph.dateAxisFormatter,
                    ticker: Dygraph.dateTicker
                  },
                  y:
                  {
                    labelsKMB: true,
                    // axisLabelWidth: 60,
                    valueRange: [0, ymax],
                  }
                },
              // ylabel: 'Primary y-axis',
              // y2label: 'Secondary y-axis',
              
              underlayCallback: function(canvas, area, g) 
              {
                canvas.fillStyle = "rgba(192, 222, 237, 1.0)";
                function highlight_period(x_start, x_end) 
                {
                  var canvas_left_x = g.toDomXCoord(x_start);
                  var canvas_right_x = g.toDomXCoord(x_end);
                  var canvas_width = canvas_right_x - canvas_left_x;
                  canvas.fillRect(canvas_left_x, area.y, canvas_width, area.h);
                }

                var min_data_x = g.getValue(0,0);
                var max_data_x = g.xAxisRange()[1];
                if (0 != signal_highlights_len)
                {
                  for (var i = 0; i < signal_highlights_len; i++)
                  {
                    var start_x_highlight = signal_highlights[i][0];
                    var end_x_highlight = signal_highlights[i][1];
                    // make sure we don't try to plot outside the graph
                    if (start_x_highlight < min_data_x)
                    {
                      start_x_highlight = min_data_x;
                    }
                    
                    if (end_x_highlight > max_data_x)
                    {
                      end_x_highlight = max_data_x;
                    }
                    highlight_period(start_x_highlight,end_x_highlight);                

                  }
                }
              }
            });
          });
        </script>
    </div>
    {% else %}
      <p>No price information available.</p>
    {% endif %}
  </div>  
</div>
<!-- Note that the below </div> tag is unmatched and closes a row opened in base.html.  The row following it is closed in the base.html file-->
</div>
<div class="row">

<div class="col-md-6">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Company Info / Holdings</h3>
    </div>

    <div class="panel-body" style="height:200px; overflow-y: scroll;">
    <p>[Some company info here?]</p>
    {% if ann_affiliations.exists %}
      
      <table class="table table-striped table-condensed">
        <thead>
          <tr>
            <th>Top Holders</th>
            <th style="text-align:right">Holding Value</th>
          </tr>
        </thead>  
        <tbody>
      {% for ann_affiliation in ann_affiliations %}
          <tr>
            <td>{{ ann_affiliation.person_name }}</td>
            <td align="right">${{ ann_affiliation.intrinsic_value|floatformat:0|intcomma }}</td>
          </tr>
      {% endfor %}
        </tbody>
      </table>

      
    {% else %}

        <p>No holdings are available.</p>
      
    {% endif %}
    </div>

  </div>  
</div>


<div class="col-md-6">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Signals</h3>
    </div>
  
    {% if signals.exists %}
      <ul class="list-group" style="height:200px; overflow-y: scroll;">
      {% for signal in signals %}
        <li class="list-group-item">
          <a href="/sdapp/{{ signal.sph.ticker_sym }}/">{{ signal.signal_date }} - {{ signal.long_statement }}</a>
        </li>
      {% endfor %}
      </ul>

    {% else %}
      <div class="panel-body" style="height:200px; overflow-y: scroll;">
        <p>No signals are available.</p>
      </div>
    {% endif %}
    </div>  
  </div>


</div>
<div class="row">

<h3>Tabular Data</h3>

<div class="list-group">

  <a href="/sdapp/{{ ticker }}/formentries" class="list-group-item">Form Entries</a>
  <a href="/sdapp/{{ ticker }}/holdings" class="list-group-item">Current Holdings</a>
  <a href="/sdapp/{{ ticker }}/byperson" class="list-group-item">Holder Table</a>
  <a href="/sdapp/{{ ticker }}/holdingtable" class="list-group-item">Holding Table</a>
</div>







{% endblock %}